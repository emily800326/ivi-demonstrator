<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\routes\themeEngineService.ts - Intel Tizen IVI Engine</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.7.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.7.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="https:&#x2F;&#x2F;www.tizen.org&#x2F;sites&#x2F;all&#x2F;themes&#x2F;tizen_theme&#x2F;logo.png" title="Intel Tizen IVI Engine"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2012105.151454</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/AbstractService.AbstractService.html">AbstractService.AbstractService</a></li>
            
                <li><a href="..&#x2F;classes/AbstractService.AbstractServiceOptions.html">AbstractService.AbstractServiceOptions</a></li>
            
                <li><a href="..&#x2F;classes/AbstractService.EndpointAction.html">AbstractService.EndpointAction</a></li>
            
                <li><a href="..&#x2F;classes/AbstractService.EndpointActionParameter.html">AbstractService.EndpointActionParameter</a></li>
            
                <li><a href="..&#x2F;classes/ApiEndpointBase.ApiEndpointBase.html">ApiEndpointBase.ApiEndpointBase</a></li>
            
                <li><a href="..&#x2F;classes/AudioService.AudioService.html">AudioService.AudioService</a></li>
            
                <li><a href="..&#x2F;classes/AudioService.StatusData.html">AudioService.StatusData</a></li>
            
                <li><a href="..&#x2F;classes/CarIndicatorService.CarIndicatorService.html">CarIndicatorService.CarIndicatorService</a></li>
            
                <li><a href="..&#x2F;classes/CarIndicatorService.RandomizerData.html">CarIndicatorService.RandomizerData</a></li>
            
                <li><a href="..&#x2F;classes/CarIndicatorService.StatusData.html">CarIndicatorService.StatusData</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.AlphabetBookmark.html">com.intel.tizen.coulomb.2012.AlphabetBookmark</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.AudioPlayer.html">com.intel.tizen.coulomb.2012.AudioPlayer</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.BottomPanel.html">com.intel.tizen.coulomb.2012.BottomPanel</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.BoxCaption.html">com.intel.tizen.coulomb.2012.BoxCaption</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.ButtonControlsObj.html">com.intel.tizen.coulomb.2012.ButtonControlsObj</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Carousel.html">com.intel.tizen.coulomb.2012.Carousel</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Clock.html">com.intel.tizen.coulomb.2012.Clock</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.ClockPlugin.html">com.intel.tizen.coulomb.2012.ClockPlugin</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.global.html">com.intel.tizen.coulomb.2012.global</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.jQuery.html">com.intel.tizen.coulomb.2012.jQuery</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Library.html">com.intel.tizen.coulomb.2012.Library</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.MusicLibraryFileSystem.html">com.intel.tizen.coulomb.2012.MusicLibraryFileSystem</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.progressBarPlugin.html">com.intel.tizen.coulomb.2012.progressBarPlugin</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Settings.html">com.intel.tizen.coulomb.2012.Settings</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Tabs.html">com.intel.tizen.coulomb.2012.Tabs</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.Themes.html">com.intel.tizen.coulomb.2012.Themes</a></li>
            
                <li><a href="..&#x2F;classes/com.intel.tizen.coulomb.2012.TopBarIcons.html">com.intel.tizen.coulomb.2012.TopBarIcons</a></li>
            
                <li><a href="..&#x2F;classes/Engine.Server.html">Engine.Server</a></li>
            
                <li><a href="..&#x2F;classes/EventSourceDispatcher.EventSourceDispatcher.html">EventSourceDispatcher.EventSourceDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/EventSourceDispatcher.EventUpdateData.html">EventSourceDispatcher.EventUpdateData</a></li>
            
                <li><a href="..&#x2F;classes/HomeScreenService.HomeScreenService.html">HomeScreenService.HomeScreenService</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.AvailablePackageData.html">PackageRepositoryService.AvailablePackageData</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.CategoryData.html">PackageRepositoryService.CategoryData</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.InstalledPackageData.html">PackageRepositoryService.InstalledPackageData</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.PackageEventData.html">PackageRepositoryService.PackageEventData</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.PackageRepositoryOptions.html">PackageRepositoryService.PackageRepositoryOptions</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.PackageRepositoryService.html">PackageRepositoryService.PackageRepositoryService</a></li>
            
                <li><a href="..&#x2F;classes/PackageRepositoryService.ThemeData.html">PackageRepositoryService.ThemeData</a></li>
            
                <li><a href="..&#x2F;classes/PersistentConsole.console.html">PersistentConsole.console</a></li>
            
                <li><a href="..&#x2F;classes/ThemeEngineService.ThemeEngineService.html">ThemeEngineService.ThemeEngineService</a></li>
            
                <li><a href="..&#x2F;classes/TizenApplicationStubService.TizenApplicationStubService.html">TizenApplicationStubService.TizenApplicationStubService</a></li>
            
                <li><a href="..&#x2F;classes/UserStatusService.UserDetails.html">UserStatusService.UserDetails</a></li>
            
                <li><a href="..&#x2F;classes/UserStatusService.UserSettings.html">UserStatusService.UserSettings</a></li>
            
                <li><a href="..&#x2F;classes/UserStatusService.UserStatusService.html">UserStatusService.UserStatusService</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\routes\themeEngineService.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import abstractService = module(&quot;abstractService&quot;);
import packageRepositoryService = module(&quot;packageRepositoryService&quot;);
import express = module(&quot;express&quot;);
import path = module(&quot;path&quot;);
import fs = module(&quot;fs&quot;);
import util = module(&quot;util&quot;);
import child_process = module(&quot;child_process&quot;);
import eventSourceDispatcher = module(&quot;..&#x2F;eventSourceDispatcher&quot;);

&#x2F;**
 * @namespace ThemeEngineService
 *&#x2F;

var request = require(&#x27;request&#x27;);
&#x2F;** 
* &#x60;&#x2F;themeEngine&#x60;
*
* Declares Theme Engine API which provides methods to operate with Car and User themes.
* Notification are sent to listeners by HTML5 &#x60;EventSource&#x60; mechanism available in class &#x60;ThemeEngine.addStatusListener&#x60; e.g.:
*
*     var themeEngine = new ThemeEngine ();   
*     themeEngine.addStatusListener(function (data) { 
*         &#x2F;&#x2F; Process theme change
*     });
*
* Themes are provided on two levels:
*
* * Car model theme (e.g. Opel Insignia, Opel Astra) utilizing car model-specific graphical assets matching real appearance inside car (e.g. leather pattern, color theme inside car etc.).
* * User theme (e.g. Retro, Fluid) defining e.g. layouts of controls, borders, font sizes, colors etc.
*
* Theme package is a ZIP file which must include &#x60;theme.json&#x60; file in package root level containing package metadata:
* 
*	{
*		&quot;id&quot;: &quot;http:&#x2F;&#x2F;com.intel.tizen&#x2F;coulomb.2012&quot;, &#x2F;&#x2F; Theme ID as will be recognized by IVI engine
*	    &quot;version&quot;: &quot;0.5.0&quot;,                          &#x2F;&#x2F; Theme version
*		&quot;name&quot;: &quot;Intel Coulomb 2012&quot;,                &#x2F;&#x2F; Human-friendly name
*		&quot;type&quot;: &quot;car&quot;                                &#x2F;&#x2F; Theme type
*	}
*
* Depending on theme type theme package *MUST* provide following files in package root level:
*
* * Car model theme - &#x60;car.css&#x60; and &#x60;car.js&#x60;
* * User theme - &#x60;user.css&#x60; and &#x60;user.js&#x60;
*
* @class ThemeEngineService
* @extends AbstractService.AbstractService
* @constructor
*&#x2F;
&#x2F;** 
* Event fired after car or user theme has been changed and HTML application should reload new theme.
* @event changed
* @for ThemeEngineService
*&#x2F;
export class ThemeEngineService extends abstractService.AbstractService {
    &#x2F;** 
    * HTTP file serving handler for selected car theme.
    * @property carThemeHandler
    * @type {Callback}
    * @private
    *&#x2F;
    private carThemeHandler: (aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) =&gt; void;
    &#x2F;** 
    * HTTP file serving handler for selected user theme.
    * @property userThemeHandler
    * @type {Callback}
    * @private
    *&#x2F;
    private userThemeHandler: (aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) =&gt; void;

    &#x2F;** 
    * @method constructor
    * @param packageRepository {PackageRepositoryService} Instance of &#x60;PackageRepositoryService&#x60;
    * @param eventSourceDispatcher {EventSourceDispatcher} Instance of &#x60;EventSourceDispatcher&#x60;
    * @param themesPath {String} Indicates location of themes directory.
    *&#x2F;
    constructor (private packageRepository: packageRepositoryService.PackageRepositoryService,
        eventSourceDispatcher: eventSourceDispatcher.EventSourceDispatcher,
                private themesPath: string = __dirname) {
        super({
            name: &quot;ThemeEngine&quot;,
            description: &quot;Theme engine&quot;,
            apiClassName: &quot;ThemeEngine&quot;,
            indexView: &quot;themeEngine&quot;,
            eventSourceDispatcher: eventSourceDispatcher
        });

        this.logger.info(&quot;Themes path: %s&quot;, this.themesPath);
    }

    attachApplication(aApplication: express.ExpressServer) {
        var self = this;

        this.actions.splice(this.actions.length, 0, {
            type: &quot;event&quot;,
            title: &quot;Theme live status&quot;,
            message: &quot;status&quot;,
            apiMethod: &quot;addStatusListener&quot;
        }, {
            type: &quot;get&quot;,
            title: &quot;Get user themes&quot;,
            apiMethod: &quot;getUserThemes&quot;,
            endpoint: &quot;&#x2F;userThemes&quot;,
            callback: this.getUserThemes
        }, {
            type: &quot;get&quot;,
            title: &quot;Get icon&quot;,
            apiMethod: &quot;getIcon&quot;,
            endpoint: &quot;&#x2F;icon&quot;,
            callback: this.getIcon,
            parameters: [{
                name: &quot;id&quot;,
                type: &quot;text&quot;,
                value: this.packageRepository.userThemes[0].id
            }]
        }, {
            type: &quot;post&quot;,
            title: &quot;Set user theme&quot;,
            apiMethod: &quot;setUserTheme&quot;,
            endpoint: &quot;&#x2F;userTheme&quot;,
            callback: this.setUserTheme,
            parameters: [{
                name: &quot;id&quot;,
                type: &quot;select&quot;,
                values: this.packageRepository.userThemes,
                value: this.packageRepository.userThemes[0].id
            }]
        }, {
            type: &quot;post&quot;,
            title: &quot;Set car theme&quot;,
            endpoint: &quot;&#x2F;carTheme&quot;,
            callback: this.setCarTheme,
            parameters: [{
                name: &quot;id&quot;,
                type: &quot;select&quot;,
                values: this.packageRepository.carThemes,
                value: this.packageRepository.carThemes[0].id
            }]
        });

        super.attachApplication(aApplication);

        aApplication.use(&#x27;&#x2F;css&#x2F;car&#x27;, function (req, res) {
            return self.carThemeHandler(req, res);
        });
        aApplication.use(&#x27;&#x2F;css&#x2F;user&#x27;, function (req, res) {
            return self.userThemeHandler(req, res);
        });

        var setThemeDirectoriesFunction = function () {
            for (var themeIndex in self.packageRepository.carThemes) {
                var carTheme = self.packageRepository.carThemes[themeIndex];
                if (carTheme.selected) {
                    var carThemePath = path.join(self.themesPath, carTheme.id.replace(&quot;http:&#x2F;&#x2F;&quot;, &quot;&quot;));
                    self.logger.info(&quot;Binding car theme to directory &#x27;%s&#x27;&quot;, carThemePath);
                    self.carThemeHandler = express.static(carThemePath);
                }
            }

            for (var themeIndex in self.packageRepository.userThemes) {
                var userTheme = self.packageRepository.userThemes[themeIndex];
                if (userTheme.selected) {
                    var userThemePath = path.join(self.themesPath, userTheme.id.replace(&quot;http:&#x2F;&#x2F;&quot;, &quot;&quot;));
                    self.logger.info(&quot;Binding user theme to directory &#x27;%s&#x27;&quot;, userThemePath);
                    self.userThemeHandler = express.static(userThemePath);
                }
            }
        };

        this.on(&quot;changed&quot;, function () {
            setThemeDirectoriesFunction();
            self.sendStatus(&quot;status&quot;);
        });

        setThemeDirectoriesFunction();

        this.packageRepository.on(&quot;changed&quot;, function (aArgs) {
            try {
                if (aArgs.type === &quot;installedTheme&quot;) {
                    var selectedCarTheme = self.packageRepository.__getCarTheme(), selectedUserTheme = self.packageRepository.__getUserTheme();
                    self.logger.info(&quot;Detected installation of theme %s&quot;, aArgs.theme);

                    self.packageRepository.__loadThemes();

                    if (aArgs.theme == selectedCarTheme.id || aArgs.theme == selectedUserTheme.id) {
                        self.logger.info(&quot;Currently selected theme was updated, forcing reload ...&quot;);
                        self.emit(&#x27;changed&#x27;);
                    }
                }
            } catch (ex) {
                self.logger.error(ex);
            }
        });
    }

    &#x2F;**
    * &#x60;[GET] &#x2F;getUserThemes&#x60; Returns available user themes
    * @method getUserThemes
    * @return {ThemeData[]} Array of available user themes
    *&#x2F;
    getUserThemes(aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) {
        aResponse.json(this.packageRepository.userThemes);
    };

    &#x2F;**
    * &#x60;[GET] &#x2F;icon&#x60; Returns theme icon
    * @method getIcon
    * @param id {String} Theme ID.
    * @return {ImageStream} Icon binary stream.
    *&#x2F;
    getIcon(aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) {
        var theme;
        this.packageRepository.userThemes.forEach(function (aItem) {
            if (aRequest.query.id == aItem.id) {
                theme = aItem;
                return true;
            }
        });

        if (!!theme) {
            var userThemePath = path.join(this.themesPath, theme.id.replace(&quot;http:&#x2F;&#x2F;&quot;, &quot;&quot;));
            aResponse.sendfile(path.join(userThemePath, theme.icon));
        }
        else
            aResponse.json({ error: util.format(&quot;Invalid theme id &#x27;%s&#x27;&quot;, aRequest.query.id) })
    };

    &#x2F;**
    * Select new user theme and emit changed event.
    * @method _setUserTheme
    * @param aId {String} Theme ID.
    * @private
    *&#x2F;
    _setUserTheme(aId: string) {
        this.packageRepository.userThemes.forEach(function (aItem) {
            aItem.selected = aItem.id === aId;
        });

        this.emit(&#x27;changed&#x27;);
    }

    &#x2F;**
    * &#x60;[POST] &#x2F;userTheme&#x60; Select new user theme
    * @method setUserTheme
    * @param id {String} Theme ID.
    * @return {ThemeData[]} Array of available user themes
    *&#x2F;
    setUserTheme(aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) {
        var themeId: string = aRequest.body.id;
        this.logger.info(&quot;Setting user theme to %s&quot;, themeId);
        this._setUserTheme(themeId);

        this.getUserThemes(aRequest, aResponse);
    }

    &#x2F;**
    * &#x60;[POST] &#x2F;carTheme&#x60; Select new car theme
    * @method setCarTheme
    * @param id {String} Theme ID.
    *&#x2F;
    setCarTheme(aRequest: express.ExpressServerRequest, aResponse: express.ExpressServerResponse) {
        var themeId: string = aRequest.body.id;
        this.logger.info(&quot;Setting car theme to %s&quot;, themeId);

        this.packageRepository.carThemes.forEach(function (aItem) {
            aItem.selected = aItem.id === themeId;
        });

        this.emit(&#x27;changed&#x27;);

        aResponse.json({ status: &quot;OK&quot; });
    }
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
